{% extends 'base.html' %}
{% load static %}

{% block title %}Schedle | –ì–ª–∞–≤–Ω–∞—è{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/main_page_v2.css' %}">
<link rel="stylesheet" href="{% static 'css/profile_modal.css' %}">
<link rel="stylesheet" href="{% static 'css/chat_view.css' %}">
{% endblock %}

{% block body_attributes %}data-user-id="{{ request.user.id }}"{% endblock %}

{% block content %}
<div class="main-layout-container">

    <!-- Left Panel: Friends and Chats -->
    <aside class="left-panel">
        <div class="left-panel-tabs">
            <button class="tab-link active" data-tab="friends-tab-content">–î—Ä—É–∑—å—è</button>
            <button class="tab-link" data-tab="chats-tab-content">–ß–∞—Ç—ã</button>
        </div>

        <div id="friends-tab-content" class="tab-content" style="display: block;">
            <button class="action-button panel-button create-group-btn">
                <span class="icon-plus-mainpage">+</span> –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
            </button>
            <a href="#" class="action-button panel-button friend-requests-btn" id="showFriendRequestsBtn">
                <span class="icon-users-mainpage">üë•</span> –ó–∞—è–≤–∫–∏ –≤ –¥—Ä—É–∑—å—è <span class="badge" id="friendRequestsCount">0</span>
            </a>
            <div id="friendRequestsContainer" class="friend-requests-list-container" style="display: none; margin-top: 10px; margin-bottom: 10px;">
                <h5>–í—Ö–æ–¥—è—â–∏–µ –∑–∞—è–≤–∫–∏:</h5>
                <div id="incomingRequestsList">
                    <!-- Requests will be loaded here -->
                </div>
            </div>

            <div class="panel-search-container" style="margin-top: 15px;">
                 <input type="text" id="userGlobalSearchInput" placeholder="üîç –ü–æ–∏—Å–∫ –Ω–æ–≤—ã—Ö –¥—Ä—É–∑–µ–π (–ø–æ username)" class="panel-search-input">
            </div>
            <div id="userGlobalSearchResultsContainer" class="user-search-results-container">
                <!-- User search results will be loaded here -->
            </div>

            <div class="panel-search-container">
                <input type="text" id="friendSearchInput" placeholder="üîç –ü–æ–∏—Å–∫ –≤ –¥—Ä—É–∑—å—è—Ö" class="panel-search-input">
            </div>
            <div class="friend-list-container" id="friendListContainer">
                <p class="placeholder-text">–ó–∞–≥—Ä—É–∑–∫–∞ –¥—Ä—É–∑–µ–π...</p>
            </div>
        </div>

        <div id="chats-tab-content" class="tab-content">
            <div class="panel-search-container">
                <input type="text" id="chatSearchInput" placeholder="üîç –ü–æ–∏—Å–∫ –≤ —á–∞—Ç–∞—Ö" class="panel-search-input">
            </div>
            <div class="chat-list-container" id="chatListContainer">
                <p class="placeholder-text">–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</p>
            </div>
        </div>
    </aside>

    <!-- Center Panel: Schedule Editing Tools -->
    <aside class="center-panel editing-panel">
        <h4>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h4>
        
        <div class="small-calendar-container">
            <div class="calendar-header-mainpage small-calendar-header">
                <div class="month-year-display">
                    <span id="currentSmallMonth">–ú–µ—Å—è—Ü</span> <span id="currentSmallYear">–ì–æ–¥</span>
                </div>
                <div class="calendar-nav-buttons">
                    <button id="prevSmallMonthBtn">&lt;</button>
                    <button id="nextSmallMonthBtn">&gt;</button>
                </div>
            </div>
            <table class="calendar-grid-mainpage small-calendar-grid">
                <thead><tr><th>–ü–ù</th><th>–í–¢</th><th>–°–†</th><th>–ß–¢</th><th>–ü–¢</th><th>–°–ë</th><th>–í–°</th></tr></thead>
                <tbody id="smallCalendarDaysBody"></tbody>
            </table>
        </div>

        <div class="event-filters-container">
            <h5>–§–∏–ª—å—Ç—Ä—ã:</h5>
            <div><input type="checkbox" id="filterPersonal" name="filterPersonal" checked> <label for="filterPersonal">–õ–∏—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è</label></div>
            <div><input type="checkbox" id="filterFriends" name="filterFriends" checked> <label for="filterFriends">–°–æ–±—ã—Ç–∏—è —Å –¥—Ä—É–∑—å—è–º–∏</label></div>
            <div><input type="checkbox" id="filterWork" name="filterWork" checked> <label for="filterWork">–†–∞–±–æ—á–∏–µ/—É—á–µ–±–Ω—ã–µ –¥–µ–ª–∞</label></div>
        </div>

        <div class="event-form-container" style="display:none;"> <!-- Hidden as per previous step -->
            <h5 id="eventFormTitle">–°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ</h5>
            <form method="POST" id="eventFormInline" action="{% url 'create_event' %}">
                {% csrf_token %}
                <input type="hidden" name="event_id" id="inline_event_id">
                <div class="form-field"><label for="id_Title">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:</label>{{ event_form.Title }}</div>
                <div class="form-field"><label for="id_StartTime">–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞:</label>{{ event_form.StartTime }}</div>
                <div class="form-field"><label for="id_EndTime">–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>{{ event_form.EndTime }}</div>
                <div class="form-field"><label for="id_Description">–û–ø–∏—Å–∞–Ω–∏–µ:</label>{{ event_form.Description }}</div>
                <div class="form-field"><label for="id_event_type">–¢–∏–ø —Å–æ–±—ã—Ç–∏—è:</label>{{ event_form.event_type }}</div>
                <div class="form-field"><label for="id_Colour">–¶–≤–µ—Ç (hex):</label>{{ event_form.Colour }}</div>
                <div class="form-actions"><button type="submit" class="action-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</button></div>
            </form>
        </div>
    </aside>

    <!-- Right Panel: Timeline Calendar -->
    <div class="timeline-section">
        <div id="timelineHeader" class="timeline-header-row"></div>
        <main class="right-panel timeline-panel" id="timelineViewContainer">
            <p class="placeholder-text">–ö–∞–ª–µ–Ω–¥–∞—Ä—å-—Ç–∞–π–º–ª–∞–π–Ω –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</p>
        </main>
    </div>

    <!-- Chat View Panel (Initially Hidden) -->
    <div id="chatViewPanel" class="chat-view-panel" style="display: none;">
        <div class="chat-view-header">
            <button id="chatViewBackButton" class="chat-header-button back-button">‚Üê –ù–∞–∑–∞–¥</button>
            <h3 id="chatViewHeaderName" class="chat-name-header">Chat Name</h3>
            <div class="chat-header-actions">
                <button id="chatViewAddParticipantButton" class="chat-header-button" style="display: none;" title="–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞">üë§+</button>
                <button id="chatViewLeaveGroupButton" class="chat-header-button" style="display: none;" title="–ü–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É">üö™</button>
            </div>
        </div>
        <div class="chat-view-messages-container" id="chatViewMessagesContainer">
            <p class="placeholder-text">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</p>
        </div>
        <div class="chat-view-input-area">
            <textarea id="chatMessageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
            <button id="sendChatMessageButton" class="action-button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
</div>

</div>

<!-- Profile Modal -->
<div class="modal" id="profileModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header"><h2 class="modal-title">–ü—Ä–æ—Ñ–∏–ª—å</h2><button class="close-button" id="profileModalCloseButton">&times;</button></div>
        <form method="POST" action="{% url 'edit_profile' %}" enctype="multipart/form-data" id="profileForm">
            {% csrf_token %}
            <div class="profile-view-main-info">
                {% if user_profile.profile_picture %}
                    <img src="{{ user_profile.profile_picture.url }}" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è" class="profile-photo-display">
                {% else %}
                    <img src="{% static 'images/default_avatar.png' %}" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è" class="profile-photo-display" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div class="profile-photo-default-circle"></div>
                {% endif %}
                <div class="profile-text-info">
                    <p class="profile-name">{{ user.get_full_name|default:user.username }}</p>
                    <p class="profile-username">@{{ user.username }}</p>
                    <p class="profile-email">{{ user.email }}</p>
                </div>
                <a href="#" id="editProfileLink" class="edit-profile-link">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</a>
            </div>
            <div id="profileEditForm" style="display: none;">
                <h4>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</h4>
                <div class="profile-edit-field"><label for="profile_pic_input">–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è:</label><input type="file" name="profile_picture" accept="image/*" id="profile_pic_input"></div>
                <div class="profile-edit-field"><label for="first_name_input">–ò–º—è:</label><input type="text" value="{{ user.first_name }}" name="first_name" id="first_name_input"></div>
                <div class="profile-edit-field"><label for="last_name_input">–§–∞–º–∏–ª–∏—è:</label><input type="text" value="{{ user.last_name }}" name="last_name" id="last_name_input"></div>
                <div class="profile-edit-field"><label for="email_input">Email:</label><input type="email" value="{{ user.email }}" name="email" id="email_input"></div>
            </div>
            <div class="profile-section-divider">–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</div>
            <div class="profile-settings-list">
                <div class="profile-field"><span>–ö—Ç–æ –≤–∏–¥–∏—Ç –ª–∏—á–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</span><a href="#" class="profile-field-value" data-setting="privacy_schedule_visibility">{{ user_profile.get_privacy_schedule_visibility_display }}</a></div>
                <div class="profile-field"><span>–ö—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≥–ª–∞—à–∞—Ç—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</span><a href="#" class="profile-field-value" data-setting="privacy_can_invite_to_event">{{ user_profile.get_privacy_can_invite_to_event_display }}</a></div>
                <div class="profile-field"><span>–ö—Ç–æ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è</span><a href="#" class="profile-field-value" data-setting="privacy_can_send_message">{{ user_profile.get_privacy_can_send_message_display }}</a></div>
                <div class="profile-field"><span>–ö—Ç–æ –≤–∏–¥–∏—Ç —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è</span><a href="#" class="profile-field-value" data-setting="privacy_profile_photo_visibility">{{ user_profile.get_privacy_profile_photo_visibility_display }}</a></div>
            </div>
            <div id="privacyEditForm" style="display: none;">
                <h4>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</h4>
                <div class="profile-edit-field"><label for="id_privacy_schedule_visibility">–ö—Ç–æ –≤–∏–¥–∏—Ç –ª–∏—á–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ:</label><select name="privacy_schedule_visibility" id="id_privacy_schedule_visibility">{% for value, text in user_profile.PRIVACY_CHOICES %}<option value="{{ value }}" {% if user_profile.privacy_schedule_visibility == value %}selected{% endif %}>{{ text }}</option>{% endfor %}</select></div>
                <div class="profile-edit-field"><label for="id_privacy_can_invite_to_event">–ö—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≥–ª–∞—à–∞—Ç—å –Ω–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:</label><select name="privacy_can_invite_to_event" id="id_privacy_can_invite_to_event">{% for value, text in user_profile.PRIVACY_CHOICES %}{% if value != 'only_me' %}<option value="{{ value }}" {% if user_profile.privacy_can_invite_to_event == value %}selected{% endif %}>{{ text }}</option>{% endif %}{% endfor %}</select></div>
                <div class="profile-edit-field"><label for="id_privacy_can_send_message">–ö—Ç–æ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è:</label><select name="privacy_can_send_message" id="id_privacy_can_send_message">{% for value, text in user_profile.PRIVACY_CHOICES %}{% if value != 'only_me' %}<option value="{{ value }}" {% if user_profile.privacy_can_send_message == value %}selected{% endif %}>{{ text }}</option>{% endif %}{% endfor %}</select></div>
                <div class="profile-edit-field"><label for="id_privacy_profile_photo_visibility">–ö—Ç–æ –≤–∏–¥–∏—Ç —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è:</label><select name="privacy_profile_photo_visibility" id="id_privacy_profile_photo_visibility">{% for value, text in user_profile.PRIVACY_CHOICES %}<option value="{{ value }}" {% if user_profile.privacy_profile_photo_visibility == value %}selected{% endif %}>{{ text }}</option>{% endfor %}</select></div>
            </div>
            <div class="profile-section-divider">–û—Å—Ç–∞–ª—å–Ω–æ–µ</div>
            <div class="profile-settings-list"><div class="profile-field"><span>–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</span><a href="#" class="profile-field-value" data-setting="interface_language">{{ user_profile.interface_language }}</a></div></div>
            <div id="languageEditForm" style="display:none;">
              <h4>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —è–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</h4>
               <div class="profile-edit-field"><label for="id_interface_language">–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:</label><select name="interface_language" id="id_interface_language"><option value="–†—É—Å—Å–∫–∏–π" {% if user_profile.interface_language == "–†—É—Å—Å–∫–∏–π" %}selected{% endif %}>–†—É—Å—Å–∫–∏–π</option><option value="English" {% if user_profile.interface_language == "English" %}selected{% endif %}>English</option></select></div>
            </div>
            <div class="profile-actions"><button type="submit" id="saveProfileButton" class="action-button" style="display:none;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button><a href="{% url 'logout' %}" class="profile-action">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</a><a href="#" class="profile-action danger" id="deleteAccountLink">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</a></div>
        </form>
    </div>
</div>

<!-- Event Create/Edit Modal -->
<div class="modal" id="eventModal" style="display: none;">
    <div class="modal-content event-modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="eventModalTitle">–°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ</h2>
            <button class="close-button" id="eventModalCloseButton">&times;</button>
        </div>
        <form method="POST" id="eventModalForm" action="{% url 'create_event' %}">
            {% csrf_token %}
            <input type="hidden" name="event_id" id="modal_event_id">
            <div class="form-field">
                <label for="modal_id_Title">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:</label>
                {{ event_form.Title }}
            </div>
            <div class="form-field">
                <label for="modal_id_StartTime">–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞:</label>
                {{ event_form.StartTime }}
            </div>
            <div class="form-field">
                <label for="modal_id_EndTime">–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
                {{ event_form.EndTime }}
            </div>
            <div class="form-field">
                <label for="modal_id_Description">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                {{ event_form.Description }}
            </div>
            <div class="form-field">
                <label for="modal_id_event_type">–¢–∏–ø —Å–æ–±—ã—Ç–∏—è:</label>
                {{ event_form.event_type }}
            </div>
            <div class="form-field">
                <label for="modal_id_Colour">–¶–≤–µ—Ç (hex):</label>
                {{ event_form.Colour }}
            </div>
            <div class="form-actions modal-form-actions">
                <button type="submit" class="action-button" id="saveEventModalButton">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>,
                <button type="button" class="action-button-secondary" id="cancelEventModalButton">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="action-button-danger" id="deleteEventModalButton" style="display:none;">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Debounce function to limit API calls during search input
function debounce(func, delay) {
    let timeout;
    return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), delay);
    };
}

document.addEventListener('DOMContentLoaded', () => {
    // --- Constants & Global Variables ---
    const defaultAvatarUrl = "{% static 'images/default_avatar.png' %}";
    const monthNames = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];
    const dayShortNames = ["–≤—Å", "–ø–Ω", "–≤—Ç", "—Å—Ä", "—á—Ç", "–ø—Ç", "—Å–±"];
    const EVENT_VERTICAL_DAY_HEIGHT_PX = 250;
    const KRASNOYARSK_TIMEZONE = 'Asia/Krasnoyarsk';
    const currentUserId = document.body.dataset.userId; // SINGLE DECLARATION
    let currentlyViewedUserId = currentUserId;

    // API URLs
    const API_GET_FRIENDS_URL = '/api/friends/';
    const API_REMOVE_FRIEND_URL = (userId) => `/api/friend/remove/${userId}/`;
    const API_GET_OR_CREATE_PRIVATE_CHAT_URL = (userId) => `/api/chat/get_or_create_private/${userId}/`;
    const API_GET_PENDING_REQUESTS_URL = '/api/friend_requests/pending/';
    const API_ACCEPT_REQUEST_URL = (reqId) => `/api/friend_request/accept/${reqId}/`;
    const API_REJECT_REQUEST_URL = (reqId) => `/api/friend_request/reject/${reqId}/`;
    const API_SEARCH_USERS_URL = (query) => `/api/users/search/?q=${encodeURIComponent(query)}`;
    const API_SEND_FRIEND_REQUEST_URL = (userId) => `/api/friend/send_request/${userId}/`;

    let currentSmallCalendarDate = new Date();
    let selectedStartDate = null;
    let selectedEndDate = null;

    // --- Helper function specific to KRT date string ---
    function getKrasnoyarskDateString(dateObj) {
        return new Intl.DateTimeFormat('sv-SE', { timeZone: KRASNOYARSK_TIMEZONE }).format(dateObj);
    }

    function convertUTCToKRT_YYYYMMDDTHHMM(utcIsoString) {
        if (!utcIsoString) return '';
        const date = new Date(utcIsoString);
        const krtYear = new Intl.DateTimeFormat('en', { year: 'numeric', timeZone: KRASNOYARSK_TIMEZONE }).format(date);
        const krtMonth = new Intl.DateTimeFormat('en', { month: '2-digit', timeZone: KRASNOYARSK_TIMEZONE }).format(date);
        const krtDay = new Intl.DateTimeFormat('en', { day: '2-digit', timeZone: KRASNOYARSK_TIMEZONE }).format(date);
        let krtHour = new Intl.DateTimeFormat('en-GB', { hour: '2-digit', hour12: false, timeZone: KRASNOYARSK_TIMEZONE }).format(date);
        const krtMinute = new Intl.DateTimeFormat('en-GB', { minute: '2-digit', timeZone: KRASNOYARSK_TIMEZONE }).format(date);
        if (krtHour === '24') krtHour = '00';
        return `${krtYear}-${krtMonth}-${krtDay}T${String(krtHour).padStart(2,'0')}:${String(krtMinute).padStart(2,'0')}`;
    }

    // --- DOM Elements ---
    const timelineViewContainer = document.getElementById('timelineViewContainer');
    const eventFormInline = document.getElementById('eventFormInline'); // Kept for potential future use, though hidden
    // const eventFormTitle = document.getElementById('eventFormTitle'); // part of inline form
    // const inlineEventIdInput = document.getElementById('inline_event_id'); // part of inline form
    
    const currentSmallMonthEl = document.getElementById('currentSmallMonth');
    const currentSmallYearEl = document.getElementById('currentSmallYear');
    const smallCalendarDaysBodyEl = document.getElementById('smallCalendarDaysBody');
    const prevSmallMonthBtn = document.getElementById('prevSmallMonthBtn');
    const nextSmallMonthBtn = document.getElementById('nextSmallMonthBtn');

    const friendSearchInput = document.getElementById('friendSearchInput');
    const chatSearchInput = document.getElementById('chatSearchInput');
    const friendListContainer = document.getElementById('friendListContainer');
    const chatListContainer = document.getElementById('chatListContainer');
    const centerPanel = document.querySelector('.center-panel.editing-panel');

    // Profile Modal Elements
    const profileButton = document.getElementById('headerProfileIcon');
    const profileModal = document.getElementById('profileModal');
    const profileModalCloseButton = document.getElementById('profileModalCloseButton');
    const editProfileLink = document.getElementById('editProfileLink');
    // const profileForm = document.getElementById('profileForm'); // Already defined by event listener
    const profileViewMainInfo = profileModal.querySelector('.profile-view-main-info');
    const profileEditForm = document.getElementById('profileEditForm');
    const privacyEditForm = document.getElementById('privacyEditForm');
    const languageEditForm = document.getElementById('languageEditForm');
    const saveProfileButton = document.getElementById('saveProfileButton');
    const deleteAccountLink = document.getElementById('deleteAccountLink');

    // Event Modal Elements
    const eventModal = document.getElementById('eventModal');
    const eventModalTitle = document.getElementById('eventModalTitle');
    const eventModalForm = document.getElementById('eventModalForm');
    const modalEventIdInput = document.getElementById('modal_event_id');
    const eventModalCloseButton = document.getElementById('eventModalCloseButton');
    // const saveEventModalButton = document.getElementById('saveEventModalButton'); // Already defined by event listener
    const cancelEventModalButton = document.getElementById('cancelEventModalButton');
    const deleteEventModalButton = document.getElementById('deleteEventModalButton');

    // Chat View Panel Elements
    const chatViewPanel = document.getElementById('chatViewPanel');
    const chatViewHeaderName = document.getElementById('chatViewHeaderName');
    const chatViewMessagesContainer = document.getElementById('chatViewMessagesContainer');
    const chatMessageInput = document.getElementById('chatMessageInput');
    const sendChatMessageButton = document.getElementById('sendChatMessageButton');
    const chatViewBackButton = document.getElementById('chatViewBackButton');

    // --- Tab switching logic ---
    const tabLinks = document.querySelectorAll('.left-panel-tabs .tab-link');
    const tabContents = document.querySelectorAll('.left-panel .tab-content');

    function openTab(targetTabId) {
        tabContents.forEach(content => {
            content.style.display = content.id === targetTabId ? 'flex' : 'none';
        });
        tabLinks.forEach(link => {
            if (link.dataset.tab === targetTabId) {
                link.classList.add('active');
            } else {
                link.classList.remove('active');
            }
        });

        // Load content for the opened tab
        if (targetTabId === 'friends-tab-content') {
            if (typeof loadFriends === 'function') loadFriends();
            else console.error('loadFriends function not found');
        } else if (targetTabId === 'chats-tab-content') {
            if (typeof loadChats === 'function') loadChats();
            else console.error('loadChats function not found');
        }
    }

    tabLinks.forEach(link => {
        link.addEventListener('click', function(event) {
            event.preventDefault();
            const targetTabId = this.dataset.tab;
            openTab(targetTabId);
        });
    });

    // --- Profile Modal Logic ---
    if (profileButton) {
        profileButton.addEventListener('click', () => {
            profileModal.style.display = 'flex';
            profileViewMainInfo.style.display = '';
            profileEditForm.style.display = 'none';
            privacyEditForm.style.display = 'none';
            languageEditForm.style.display = 'none';
            saveProfileButton.style.display = 'none';
            editProfileLink.textContent = '‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å';
            profileModal.querySelectorAll('.profile-settings-list').forEach(list => list.style.display = '');
        });
    }
    if (profileModalCloseButton) profileModalCloseButton.addEventListener('click', () => profileModal.style.display = 'none');
    if (editProfileLink) {
        editProfileLink.addEventListener('click', (e) => {
            e.preventDefault();
            const isEditing = profileEditForm.style.display !== 'none';
            profileViewMainInfo.style.display = isEditing ? '' : 'none';
            profileEditForm.style.display = isEditing ? 'none' : 'block';
            privacyEditForm.style.display = isEditing ? 'none' : 'block';
            languageEditForm.style.display = isEditing ? 'none' : 'block';
            saveProfileButton.style.display = isEditing ? 'none' : 'block';
            editProfileLink.textContent = isEditing ? '‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å' : '‚Ü©Ô∏è –û—Ç–º–µ–Ω–∞';
            profileModal.querySelectorAll('.profile-settings-list').forEach(list => list.style.display = isEditing ? '' : 'none');
        });
    }
    if (deleteAccountLink) {
        deleteAccountLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) {
                alert('–ê–∫–∫–∞—É–Ω—Ç —É–¥–∞–ª–µ–Ω (–¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è).'); window.location.href = '/';
            }
        });
    }

    // --- Small Calendar Functionality ---
    function renderSmallCalendar() {
        const localYear = currentSmallCalendarDate.getFullYear();
        const localMonth = currentSmallCalendarDate.getMonth();
        if (currentSmallMonthEl) currentSmallMonthEl.textContent = monthNames[localMonth];
        if (currentSmallYearEl) currentSmallYearEl.textContent = localYear;
        const timelineHeaderMonthTitle = document.querySelector('#timelineHeader .timeline-month-title');
        if (timelineHeaderMonthTitle) timelineHeaderMonthTitle.textContent = monthNames[localMonth];
        if (!smallCalendarDaysBodyEl) return;
        smallCalendarDaysBodyEl.innerHTML = '';
        const firstOfDisplayedMonthKRT = new Date(Date.UTC(localYear, localMonth, 1, 0, 0, 0 - (7*60*60*1000) ) );
        const krtYearForLogic = parseInt(new Intl.DateTimeFormat('en', { year: 'numeric', timeZone: KRASNOYARSK_TIMEZONE }).format(firstOfDisplayedMonthKRT));
        const krtMonthForLogic = parseInt(new Intl.DateTimeFormat('en', { month: 'numeric', timeZone: KRASNOYARSK_TIMEZONE }).format(firstOfDisplayedMonthKRT)) -1;
        const firstDayOfMonthObject = new Date(krtYearForLogic, krtMonthForLogic, 1);
        const firstDayOfMonthWeekday = firstDayOfMonthObject.toLocaleDateString('en-US', { weekday: 'long', timeZone: KRASNOYARSK_TIMEZONE });
        const dayNameToIndex = {'Monday':0, 'Tuesday':1, 'Wednesday':2, 'Thursday':3, 'Friday':4, 'Saturday':5, 'Sunday':6};
        let startingDay = dayNameToIndex[firstDayOfMonthWeekday] !== undefined ? dayNameToIndex[firstDayOfMonthWeekday] : (new Date(localYear, localMonth, 1).getDay() + 6) % 7;
        const daysInMonth = new Date(krtYearForLogic, krtMonthForLogic + 1, 0).getDate();
        const daysInPrevMonth = new Date(krtYearForLogic, krtMonthForLogic, 0).getDate();
        let dateCounter = 1, nextMonthDateCounter = 1;
        for (let i = 0; i < 6; i++) {
            const row = document.createElement('tr');
            for (let j = 0; j < 7; j++) {
                const cell = document.createElement('td');
                const dateNumberDiv = document.createElement('div'); dateNumberDiv.classList.add('date-number');
                let cellRepresentedDateObj, cellDateKRTString;
                if (i === 0 && j < startingDay) {
                    const prevMonthDay = daysInPrevMonth - startingDay + j + 1;
                    dateNumberDiv.textContent = prevMonthDay; cell.classList.add('other-month');
                    cellRepresentedDateObj = new Date(krtYearForLogic, krtMonthForLogic - 1, prevMonthDay);
                } else if (dateCounter > daysInMonth) {
                    dateNumberDiv.textContent = nextMonthDateCounter; cell.classList.add('other-month');
                    cellRepresentedDateObj = new Date(krtYearForLogic, krtMonthForLogic + 1, nextMonthDateCounter++);
                } else {
                    dateNumberDiv.textContent = dateCounter; cell.classList.add('current-month', 'calendar-day-mainpage');
                    cellRepresentedDateObj = new Date(krtYearForLogic, krtMonthForLogic, dateCounter);
                    if (getKrasnoyarskDateString(cellRepresentedDateObj) === getKrasnoyarskDateString(new Date())) cell.classList.add('today-mainpage');
                    dateCounter++;
                }
                cellDateKRTString = getKrasnoyarskDateString(cellRepresentedDateObj);
                cell.dataset.date = cellDateKRTString; cell.appendChild(dateNumberDiv);
                if (selectedStartDate && selectedEndDate && cellDateKRTString >= selectedStartDate && cellDateKRTString <= selectedEndDate) cell.classList.add('selected-range');
                if (cellDateKRTString === selectedStartDate) cell.classList.add('selected-start');
                if (cellDateKRTString === selectedEndDate) cell.classList.add('selected-end');
                row.appendChild(cell);
            }
            smallCalendarDaysBodyEl.appendChild(row);
            if (dateCounter > daysInMonth && i >= Math.floor((startingDay + daysInMonth -1) / 7) ) break; 
        }
    }
    if (prevSmallMonthBtn) prevSmallMonthBtn.addEventListener('click', () => { 
        currentSmallCalendarDate.setMonth(currentSmallCalendarDate.getMonth() - 1); 
        selectedStartDate = null; selectedEndDate = null; renderSmallCalendar(); 
        const y = currentSmallCalendarDate.getFullYear(), m = currentSmallCalendarDate.getMonth();
        generateTimelineView(new Date(y, m, 1), new Date(y, m + 1, 0));
    });
    if (nextSmallMonthBtn) nextSmallMonthBtn.addEventListener('click', () => { 
        currentSmallCalendarDate.setMonth(currentSmallCalendarDate.getMonth() + 1); 
        selectedStartDate = null; selectedEndDate = null; renderSmallCalendar(); 
        const y = currentSmallCalendarDate.getFullYear(), m = currentSmallCalendarDate.getMonth();
        generateTimelineView(new Date(y, m, 1), new Date(y, m + 1, 0));
    });
    if (smallCalendarDaysBodyEl) smallCalendarDaysBodyEl.addEventListener('click', (e) => {
            const targetCell = e.target.closest('td');
            if (!targetCell || !targetCell.dataset.date) return;
            const clickedDateStr = targetCell.dataset.date;
        if (!selectedStartDate || (selectedStartDate && selectedEndDate)) { selectedStartDate = clickedDateStr; selectedEndDate = null; } 
        else if (clickedDateStr < selectedStartDate) { selectedEndDate = selectedStartDate; selectedStartDate = clickedDateStr;} 
        else { selectedEndDate = clickedDateStr;}
        renderSmallCalendar(); 
            if (timelineViewContainer) {
            const start = new Date(selectedStartDate + "T00:00:00+07:00");
            const end = selectedEndDate ? new Date(selectedEndDate + "T23:59:59.999+07:00") : new Date(selectedStartDate + "T23:59:59.999+07:00");
                 generateTimelineView(start, end);
            }
        });

    // --- Timeline View Generation ---
    async function generateTimelineView(startDate, endDate) {
        if (!timelineViewContainer) return;
        if (!(startDate instanceof Date) || isNaN(startDate.getTime()) || !(endDate instanceof Date) || isNaN(endDate.getTime())) {
            timelineViewContainer.innerHTML = '<p class="placeholder-text">–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞—Ç—ã.</p>'; return;
        }
        timelineViewContainer.innerHTML = '<p class="placeholder-text">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–Ω–µ–π...</p>';
        let currentDate = new Date(startDate); currentDate.setHours(0,0,0,0);
        let tempEndDate = new Date(endDate); tempEndDate.setHours(23,59,59,999);
        if (currentDate > tempEndDate) { timelineViewContainer.innerHTML = '<p class="placeholder-text">–î–∏–∞–ø–∞–∑–æ–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.</p>'; return;}
        const fragment = document.createDocumentFragment(); let dayRendered = false;
        while (currentDate <= tempEndDate) {
            dayRendered = true;
            const dayDateForAPI = getKrasnoyarskDateString(currentDate);
            const dayEntry = document.createElement('div'); dayEntry.className = 'timeline-day-entry-vertical'; dayEntry.dataset.date = dayDateForAPI;
            const dayLabelDiv = document.createElement('div'); dayLabelDiv.className = 'day-label-main-vertical';
            dayLabelDiv.innerHTML = `<span class="day-label-date-number">${currentDate.getDate()}</span><span class="day-label-day-name">${dayShortNames[currentDate.getDay()]}</span>`;
            dayLabelDiv.addEventListener('click', () => {
                if(eventModalTitle) eventModalTitle.textContent = '–°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ';
                if(eventModalForm) { eventModalForm.reset(); eventModalForm.action = "{% url 'create_event' %}";
                    eventModalForm.querySelector('[name="StartTime"]').value = dayEntry.dataset.date + 'T09:00';
                    eventModalForm.querySelector('[name="EndTime"]').value = dayEntry.dataset.date + 'T10:00';
                    eventModalForm.querySelector('[name="Colour"]').value = '#007bff'; }
                if(modalEventIdInput) modalEventIdInput.value = ''; if(deleteEventModalButton) deleteEventModalButton.style.display = 'none';
                openEventModal();
            });
            const dayBodyVertical = document.createElement('div'); dayBodyVertical.className = 'timeline-day-body-vertical';
            const eventArea = document.createElement('div'); eventArea.className = 'event-area-vertical';
            dayBodyVertical.appendChild(eventArea); dayEntry.appendChild(dayLabelDiv); dayEntry.appendChild(dayBodyVertical); fragment.appendChild(dayEntry);
            await fetchAndDisplayEventsForDayRow(new Date(currentDate), eventArea, dayDateForAPI, currentlyViewedUserId);
            currentDate.setDate(currentDate.getDate() + 1);
        }
        if (dayRendered) { timelineViewContainer.innerHTML = ''; timelineViewContainer.appendChild(fragment);}
        else { timelineViewContainer.innerHTML = '<p class="placeholder-text">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π.</p>';}
    }
    async function fetchAndDisplayEventsForDayRow(dateObj, eventAreaElement, krtDateStrForAPI, targetUserId) {
        eventAreaElement.innerHTML = ''; 
        try {
            const response = await fetch(`/api/user_events/${targetUserId}/${krtDateStrForAPI}/`);
            if (!response.ok) { eventAreaElement.innerHTML = '<span class="timeline-event-placeholder">–û—à–∏–±–∫–∞</span>'; return;}
            const events = (await response.json()).filter(e => e && e.StartTime && e.EndTime && e.Title);
            if (events.length === 0) { eventAreaElement.innerHTML = '<span class="timeline-event-placeholder">–Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π</span>'; return;}
            const viewWindowStartForDay_TrueUTC = new Date(Date.parse(krtDateStrForAPI + "T06:00:00+07:00"));
            const viewWindowEndForDay_TrueUTC = new Date(viewWindowStartForDay_TrueUTC.getTime() + 24*60*60*1000);
            const TOTAL_MINUTES_IN_VIEW = 1440;
            let processedEvents = events.map(event => {
                const ensureUTC = (dStr) => dStr.endsWith('Z') || /[+\-]\d{2}:?\d{2}$/.test(dStr) ? new Date(dStr) : new Date(dStr+'Z');
                let actualStart = ensureUTC(event.StartTime), actualEnd = ensureUTC(event.EndTime);
                if (!actualStart || !actualEnd) return null;
                let cStart = actualStart < viewWindowStartForDay_TrueUTC ? viewWindowStartForDay_TrueUTC : actualStart;
                let cEnd = actualEnd > viewWindowEndForDay_TrueUTC ? viewWindowEndForDay_TrueUTC : actualEnd;
                if (cStart >= cEnd) return null;
                let startM = Math.max(0, (cStart.getTime() - viewWindowStartForDay_TrueUTC.getTime())/60000);
                let durationM = Math.max(15, (cEnd.getTime() - cStart.getTime())/60000);
                if (startM + durationM > TOTAL_MINUTES_IN_VIEW) durationM = TOTAL_MINUTES_IN_VIEW - startM;
                if (durationM <= 0) return null;
                return {...event, originalStartTime: actualStart, originalEndTime: actualEnd, startMinutes: startM, durationMinutes: durationM,
                    leftPercent: (startM / TOTAL_MINUTES_IN_VIEW) * 100, widthPercent: (durationM / TOTAL_MINUTES_IN_VIEW) * 100 };
            }).filter(e => e !== null);
            processedEvents.sort((a,b) => a.startMinutes - b.startMinutes || (b.startMinutes+b.durationMinutes) - (a.startMinutes+a.durationMinutes));
            const eventHeightPx = 60, eventGapPx = 6; processedEvents.forEach(e => e.lane = 0);
            for (let i=0; i < processedEvents.length; i++) { let current = processedEvents[i], lane = 0, conflict = false;
                do { conflict = false; for (let j=0; j < i; j++) { let placed = processedEvents[j];
                    if (placed.lane === lane && current.startMinutes < (placed.startMinutes+placed.durationMinutes) && (current.startMinutes+current.durationMinutes) > placed.startMinutes) { conflict=true; lane++; break; }}
                } while (conflict); current.lane = lane; }
            eventAreaElement.style.minHeight = `${processedEvents.reduce((max,e)=>Math.max(max,e.lane+1),0)*(eventHeightPx+eventGapPx)+eventGapPx}px`;
            processedEvents.forEach(event => {
                const item = document.createElement('div'); item.className = 'timeline-event-item'; item.dataset.eventId = event.id;
                item.style.cssText = `background-color:${event.Colour|| '#007bff'};position:absolute;left:${event.leftPercent}%;width:${Math.min(99.8,event.widthPercent-.2)}%;top:${event.lane*(eventHeightPx+eventGapPx)+eventGapPx}px;height:${eventHeightPx}px;`;
                const krtDispOpts = {timeZone:KRASNOYARSK_TIMEZONE,hour:'2-digit',minute:'2-digit'}, krtTipOpts = {...krtDispOpts,year:'numeric',month:'numeric',day:'numeric'};
                item.innerHTML = `<div class="timeline-event-time-start">${event.originalStartTime.toLocaleTimeString('ru-RU',krtDispOpts)}</div><strong class="timeline-event-title">${event.Title}</strong>`;
                item.title = `${event.Title} (${event.originalStartTime.toLocaleString('ru-RU',krtTipOpts)} - ${event.originalEndTime.toLocaleString('ru-RU',krtTipOpts)})`;
                item.addEventListener('click', () => openModalForEdit(event.id)); eventAreaElement.appendChild(item);
            });
        } catch (error) { eventAreaElement.innerHTML = '<span class="timeline-event-placeholder">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</span>'; }
    }

    // --- Modal Event Form ---
    async function openModalForEdit(eventId) {
        if (!eventModalForm) return;
        try {
            const response = await fetch(`/api/event_detail/${eventId}/`); if (!response.ok) throw new Error('Fetch fail');
            const d = await response.json(); if(eventModalTitle) eventModalTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ';
            if(modalEventIdInput) modalEventIdInput.value = d.id; eventModalForm.action = `/edit_event/${d.id}/`;
            eventModalForm.querySelector('[name="Title"]').value=d.Title||''; eventModalForm.querySelector('[name="StartTime"]').value=convertUTCToKRT_YYYYMMDDTHHMM(d.StartTime);
            eventModalForm.querySelector('[name="EndTime"]').value=convertUTCToKRT_YYYYMMDDTHHMM(d.EndTime); eventModalForm.querySelector('[name="Description"]').value=d.Description||'';
            eventModalForm.querySelector('[name="event_type"]').value=d.event_type||'personal'; eventModalForm.querySelector('[name="Colour"]').value=(d.Colour && d.Colour.match(/^#[0-9a-fA-F]{6}$/))?d.Colour:'#007bff';
            if(deleteEventModalButton) deleteEventModalButton.style.display = 'inline-block'; openEventModal();
        } catch (error) { alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ.'); }
    }
    if (eventModalForm) eventModalForm.addEventListener('submit', async function(e) {
        e.preventDefault(); const formData = new FormData(eventModalForm), url = eventModalForm.action;
        try {
            const response = await fetch(url, {method:'POST',body:formData,headers:{'X-CSRFToken':formData.get('csrfmiddlewaretoken')}});
            if (response.ok && response.headers.get("content-type")?.includes("application/json")) {
                const d = await response.json(); if (d.status === "success") { alert(d.message||'–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!'); closeEventModal();
                    if (selectedStartDate) generateTimelineView(new Date(selectedStartDate+"T00:00:00+07:00"),selectedEndDate?new Date(selectedEndDate+"T23:59:59.999+07:00"):new Date(selectedStartDate+"T23:59:59.999+07:00"));
                    else {const t=new Date(); generateTimelineView(new Date(t.getFullYear(),t.getMonth(),1),new Date(t.getFullYear(),t.getMonth()+1,0));}
                } else { let errs=d.message||'–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å.'; if(d.errors)errs+=Object.entries(d.errors).map(([f,e])=>`\n- ${f}: ${e.join(',')}`).join(''); alert('–û—à–∏–±–∫–∞: '+errs);}
            } else { alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞.');}
        } catch (error) { alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã.');}
    });
    if (deleteEventModalButton) deleteEventModalButton.addEventListener('click', async function() {
        const eventId = modalEventIdInput.value; if (!eventId || !confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ?')) return;
        try {
            const response = await fetch(`/event/delete/${eventId}/`,{method:'POST',headers:{'X-CSRFToken':getCookie('csrftoken'),'Content-Type':'application/json'}});
            if (response.ok) { const d = await response.json(); if (d.status === "success") { alert(d.message||'–£–¥–∞–ª–µ–Ω–æ!'); closeEventModal();
                if (selectedStartDate) generateTimelineView(new Date(selectedStartDate+"T00:00:00+07:00"),selectedEndDate?new Date(selectedEndDate+"T23:59:59.999+07:00"):new Date(selectedStartDate+"T23:59:59.999+07:00"));
                else {const t=new Date(); generateTimelineView(new Date(t.getFullYear(),t.getMonth(),1),new Date(t.getFullYear(),t.getMonth()+1,0));}
            } else alert('–û—à–∏–±–∫–∞: '+(d.message||'–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å.'));} 
            else {const errD=await response.json().catch(()=>({}));alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: '+(errD.message||`–ö–æ–¥ ${response.status}`));}
        } catch (error) { alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è.');}
    });
    function openEventModal() { if (eventModal) eventModal.style.display = 'flex'; }
    function closeEventModal() { if (eventModal) eventModal.style.display='none'; if(eventModalForm)eventModalForm.reset(); if(modalEventIdInput)modalEventIdInput.value=''; if(deleteEventModalButton)deleteEventModalButton.style.display='none';}
    if(eventModalCloseButton) eventModalCloseButton.addEventListener('click', closeEventModal);
    if(cancelEventModalButton) cancelEventModalButton.addEventListener('click', closeEventModal);
    window.addEventListener('click', (event)=>{if(event.target===eventModal)closeEventModal();});

    // --- View Toggling & Chat ---
    function showTimelineView() {
        stopChatPolling(); // Stop polling when leaving chat view
        console.log("Attempting to show Timeline View");
        if (timelineViewContainer) timelineViewContainer.style.display = '';
        if (centerPanel) centerPanel.style.display = '';
        if (chatViewPanel) chatViewPanel.style.display = 'none';
        const timelineHeaderControls = document.querySelector('.timeline-header-controls');
        if (timelineHeaderControls) timelineHeaderControls.style.display = 'flex';
        const timelineUserDisplay = document.getElementById('timelineUserDisplay');
        if (timelineUserDisplay && currentlyViewedUserId === currentUserId) {
            timelineUserDisplay.textContent = '–ú–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ';
        } 
        console.log("Timeline View should be visible now.");
    }

    function showChatView(roomId, chatName, isGroup = false, creatorId = null, participantIds = []) {
        stopChatPolling(); // Stop any previous polling before starting a new one
        console.log(`Attempting to show Chat View for: ${chatName} (ID: ${roomId})`);
        
        if (timelineViewContainer) timelineViewContainer.style.display = 'none';
        if (centerPanel) centerPanel.style.display = 'none';
        if (eventModal && eventModal.style.display !== 'none') closeEventModal();
        
        if (chatViewPanel) chatViewPanel.style.display = 'flex';
        if (chatViewHeaderName) chatViewHeaderName.textContent = chatName || '–ß–∞—Ç';
        if (chatViewPanel) chatViewPanel.dataset.currentRoomId = roomId;

        const addParticipantBtn = document.getElementById('chatViewAddParticipantButton');
        const leaveGroupBtn = document.getElementById('chatViewLeaveGroupButton');

        if (isGroup) {
            if (addParticipantBtn) addParticipantBtn.style.display = 'inline-block';
            if (leaveGroupBtn) leaveGroupBtn.style.display = 'inline-block';
            if(chatViewPanel) {
                chatViewPanel.dataset.isGroup = 'true';
                chatViewPanel.dataset.creatorId = creatorId || '';
                chatViewPanel.dataset.participantIds = JSON.stringify(participantIds || []);
            }
        } else {
            if (addParticipantBtn) addParticipantBtn.style.display = 'none';
            if (leaveGroupBtn) leaveGroupBtn.style.display = 'none';
            if(chatViewPanel) {
                 chatViewPanel.dataset.isGroup = 'false';
                 chatViewPanel.dataset.participantIds = JSON.stringify(participantIds || []);
            }
        }
        
        const timelineHeaderControls = document.querySelector('.timeline-header-controls');
        if (timelineHeaderControls) timelineHeaderControls.style.display = 'none';

        if (typeof fetchAndDisplayMessages === 'function') {
            fetchAndDisplayMessages(roomId, true); // Initial load, scroll to bottom
            
            chatPollingIntervalId = setInterval(() => {
                console.log(`Polling for messages in room ${roomId}...`);
                fetchAndDisplayMessages(roomId, false); // Subsequent loads
            }, POLLING_INTERVAL_MS);
            console.log(`Chat polling started for room ${roomId}, interval ID: ${chatPollingIntervalId}`);
        } else {
            console.error('fetchAndDisplayMessages is not defined');
        }
        console.log("Chat View should be visible now.");
    }

    async function fetchAndDisplayMessages(roomId, scrollToBottom = false) {
        if (!chatViewMessagesContainer) return;
        
        const isUserAtBottom = chatViewMessagesContainer.scrollHeight - chatViewMessagesContainer.clientHeight <= chatViewMessagesContainer.scrollTop + 1;

        // For initial load, show placeholder. For polls, maybe not, to prevent flicker.
        if (scrollToBottom) { 
             chatViewMessagesContainer.innerHTML = '<p class="placeholder-text">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</p>';
        }

        try {
            const response = await fetch(`/api/chat_messages/${roomId}/`); 
            if (!response.ok) {
                const eData = await response.json().catch(()=>({}));
                if (scrollToBottom) { // Only show error over content on initial load
                    chatViewMessagesContainer.innerHTML = `<p class="placeholder-text" style="color:red;">–û—à–∏–±–∫–∞: ${eData.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è'}</p>`;
                }
                console.error("Failed to fetch messages:", eData);
                return;
            }
            const messages = await response.json(); 

            // Simple check to avoid re-render if message list hasn't changed (can be improved)
            const currentMessagesHTML = Array.from(chatViewMessagesContainer.querySelectorAll('.chat-message-item')).map(el => el.outerHTML).join('');
            const newMessagesHTML = messages.map(msg => {
                 const item = document.createElement('div'); 
                 item.className=`chat-message-item ${msg.sender_id.toString() === currentUserId.toString() ?'sent':'received'}`;
                 const time=new Date(msg.timestamp).toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});
                 item.innerHTML =
                    `<div class="message-avatar-container">
                        <img src="${msg.sender_profile_picture_url||defaultAvatarUrl}" class="message-avatar" alt="${msg.sender_username}" onerror="this.src='${defaultAvatarUrl}'">
                    </div>
                    <div class="message-content-container">
                        <div class="message-sender-name">${msg.sender_username}</div>
                        <div class="message-text">${msg.content}</div>
                        <div class="message-timestamp">${time}</div>
                    </div>`;
                return item.outerHTML;
            }).join('');

            if (!scrollToBottom && currentMessagesHTML === newMessagesHTML && messages.length > 0) {
                // console.log("No new messages based on HTML content comparison.");
                return;
            }
            
            chatViewMessagesContainer.innerHTML = ''; 
            if (messages.length === 0) {
                chatViewMessagesContainer.innerHTML = '<p class="placeholder-text">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —ç—Ç–æ–º —á–∞—Ç–µ.</p>';
                return;
            }
            messages.forEach(msg => { 
                const item = document.createElement('div'); 
                item.className = `chat-message-item ${msg.sender_id.toString() === currentUserId.toString() ? 'sent' : 'received'}`;
                const time = new Date(msg.timestamp).toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});
                item.innerHTML =
                    `<div class="message-avatar-container">
                        <img src="${msg.sender_profile_picture_url||defaultAvatarUrl}" class="message-avatar" alt="${msg.sender_username}" onerror="this.src='${defaultAvatarUrl}'">
                    </div>
                    <div class="message-content-container">
                        <div class="message-sender-name">${msg.sender_username}</div>
                        <div class="message-text">${msg.content}</div>
                        <div class="message-timestamp">${time}</div>
                    </div>`;
                chatViewMessagesContainer.appendChild(item); 
            }); 
            
            if (scrollToBottom || isUserAtBottom) {
                chatViewMessagesContainer.scrollTop = chatViewMessagesContainer.scrollHeight;
            }
        } catch (error) { 
            console.error("Error in fetchAndDisplayMessages:", error);
            if (scrollToBottom || !chatViewMessagesContainer.hasChildNodes() || chatViewMessagesContainer.innerHTML.includes('placeholder-text')) {
                chatViewMessagesContainer.innerHTML = `<p class="placeholder-text" style="color:red;">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π: ${error.message}</p>`;
            }
        }
    }
    if (sendChatMessageButton && chatMessageInput) {
        sendChatMessageButton.addEventListener('click', async () => {
            const content=chatMessageInput.value.trim(),roomId=chatViewPanel.dataset.currentRoomId; if(!content||!roomId){alert('–°–æ–æ–±—â–µ–Ω–∏–µ –ø—É—Å—Ç–æ–µ –∏–ª–∏ —á–∞—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω.');return;}
            try { const r=await fetch(`/chat/${roomId}/send/`,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded','X-CSRFToken':getCookie('csrftoken')},body:`content=${encodeURIComponent(content)}`});
                if(r.ok){
                    chatMessageInput.value = '';
                    fetchAndDisplayMessages(roomId, true); // Fetch and scroll to bottom
                    if(typeof loadChats === 'function') loadChats(); 
                } else { 
                    const e=await r.json().catch(()=>({}));alert(`–û—à–∏–±–∫–∞: ${e.message||'–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å.'}`);
                }
            } catch(error){alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏.');}});
        chatMessageInput.addEventListener('keypress',(e)=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChatMessageButton.click();}});
    }

    // --- Friend System Functions ---
    async function updateFriendRequestsBadge() {
        const badge = document.getElementById('friendRequestsCount'); if (!badge) return;
        try {
            const response = await fetch(API_GET_PENDING_REQUESTS_URL);
            if (!response.ok) throw new Error('Network error for badge.');
            const requests = await response.json();
            badge.textContent = requests.length > 0 ? requests.length : '0';
            badge.style.display = requests.length > 0 ? 'inline-block' : 'none';
        } catch (error) { badge.textContent = '!'; badge.style.display = 'inline-block';}
    }
    async function displayFriendRequests() {
        const reqContainer = document.getElementById('incomingRequestsList');
        const mainCont = document.getElementById('friendRequestsContainer');
        if (!reqContainer || !mainCont) return;
        reqContainer.innerHTML = '<p class="placeholder-text">–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
        mainCont.style.display = 'block'; // Ensure the container is visible

        try {
            const response = await fetch(API_GET_PENDING_REQUESTS_URL);
            if (!response.ok) throw new Error('Fetch fail for friend requests');
            const requests = await response.json();
            updateFriendRequestsBadge(); // Make sure this function is defined and works

            if (requests.length === 0) {
                reqContainer.innerHTML = '<p class="placeholder-text">–ù–µ—Ç –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞—è–≤–æ–∫.</p>';
                return;
            }
            reqContainer.innerHTML = ''; // Clear loading text
            requests.forEach(req => {
                const item = document.createElement('div');
                item.className = 'friend-request-item';
                item.innerHTML = `
                    <img src="${req.requester_profile_pic || defaultAvatarUrl}" class="friend-avatar-small" onerror="this.src='${defaultAvatarUrl}'">
                    <div class="friend-request-info">
                        <span class="friend-request-name">${req.requester_username}</span>
                        <span class="friend-request-time">${new Date(req.created_at).toLocaleString('ru-RU')}</span>
                    </div>
                    <div class="friend-request-actions">
                        <button class="action-button-small accept js-accept-request" data-request-id="${req.id}">–ü—Ä–∏–Ω—è—Ç—å</button>
                        <button class="action-button-small reject js-reject-request" data-request-id="${req.id}">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                    </div>
                `;
                reqContainer.appendChild(item);

                // Add event listeners for accept/reject buttons
                const acceptBtn = item.querySelector('.js-accept-request');
                if (acceptBtn) {
                    acceptBtn.addEventListener('click', function() {
                        acceptFriendRequest(this.dataset.requestId);
                    });
                }

                const rejectBtn = item.querySelector('.js-reject-request');
                if (rejectBtn) {
                    rejectBtn.addEventListener('click', function() {
                        rejectFriendRequest(this.dataset.requestId);
                    });
                }
            });
        } catch (error) {
            reqContainer.innerHTML = '<p class="placeholder-text" style="color:red;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞—è–≤–∫–∏.</p>';
            console.error('Error in displayFriendRequests:', error);
        }
    }
    window.acceptFriendRequest = async (friendshipId) => {
        try { const r=await fetch(API_ACCEPT_REQUEST_URL(friendshipId),{method:'POST',headers:{'X-CSRFToken':getCookie('csrftoken'),'Content-Type':'application/json'}}); const d=await r.json();
            if(r.ok&&d.status==='success'){alert(d.message);loadFriends();displayFriendRequests();}else{throw new Error(d.message||'Fail');}}
        catch(error){alert('–û—à–∏–±–∫–∞: '+error.message);}};
    window.rejectFriendRequest = async (friendshipId) => {
        try { const r=await fetch(API_REJECT_REQUEST_URL(friendshipId),{method:'POST',headers:{'X-CSRFToken':getCookie('csrftoken'),'Content-Type':'application/json'}}); const d=await r.json();
            if(r.ok&&d.status==='success'){alert(d.message);displayFriendRequests();}else{throw new Error(d.message||'Fail');}}
        catch(error){alert('–û—à–∏–±–∫–∞: '+error.message);}};
    async function searchGlobalUsers() {
        const queryInput = document.getElementById('userGlobalSearchInput');
        const resultsCont = document.getElementById('userGlobalSearchResultsContainer');
        if (!queryInput || !resultsCont) return;

        const query = queryInput.value;
        if (query.length < 2) {
            resultsCont.innerHTML = '';
            return;
        }
        resultsCont.innerHTML = '<p class="placeholder-text">–ü–æ–∏—Å–∫...</p>';

        try {
            const response = await fetch(API_SEARCH_USERS_URL(query));
            if (!response.ok) throw new Error('Search API fail');
            const data = await response.json();
            const users = data.users;

            if (users.length === 0) {
                resultsCont.innerHTML = '<p class="placeholder-text">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>';
                return;
            }
            resultsCont.innerHTML = '';
            users.forEach(user => {
                const item = document.createElement('div');
                item.className = 'user-search-item';
                let btnHtml = '';

                switch (user.status) {
                    case 'can_send_request':
                        btnHtml = `<button class="action-button-small add js-send-friend-request" data-user-id="${user.id}">–î–æ–±–∞–≤–∏—Ç—å</button>`;
                        break;
                    case 'request_sent':
                        btnHtml = `<span class="status-text">–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω</span>`;
                        break;
                    case 'request_received':
                        btnHtml = `<button class="action-button-small view-request js-display-friend-requests" data-user-id="${user.id}">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞—è–≤–∫—É</button>`;
                        break;
                    case 'already_friends':
                        btnHtml = `<span class="status-text">–£–∂–µ –≤ –¥—Ä—É–∑—å—è—Ö</span>`;
                        break;
                    default:
                        btnHtml = '';
                }

                item.innerHTML = `
                    <img src="${user.profile_picture_url || defaultAvatarUrl}" class="friend-avatar-small" onerror="this.src='${defaultAvatarUrl}'">
                    <div class="user-search-info">
                        <span class="user-search-name">${user.username} (${user.full_name || ''})</span>
                    </div>
                    <div class="user-search-actions">${btnHtml}</div>
                `;
                resultsCont.appendChild(item);

                // Add event listeners for dynamically created buttons
                const sendRequestBtn = item.querySelector('.js-send-friend-request');
                if (sendRequestBtn) {
                    sendRequestBtn.addEventListener('click', function() {
                        sendFriendRequest(this.dataset.userId, this);
                    });
                }

                const displayRequestsBtn = item.querySelector('.js-display-friend-requests');
                if (displayRequestsBtn) {
                    displayRequestsBtn.addEventListener('click', function() {
                        if (typeof displayFriendRequests === 'function') {
                            displayFriendRequests();
                        } else {
                            console.error('displayFriendRequests function is not defined');
                        }
                    });
                }
            });
            } catch (error) {
            resultsCont.innerHTML = '<p class="placeholder-text" style="color:red;">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞.</p>';
            console.error('Error in searchGlobalUsers:', error);
        }
    }
    window.sendFriendRequest = async (userId, buttonElement) => {
        try { const r=await fetch(API_SEND_FRIEND_REQUEST_URL(userId),{method:'POST',headers:{'X-CSRFToken':getCookie('csrftoken'),'Content-Type':'application/json'}}); const d=await r.json();
            if(r.ok&&(d.status==='success'||d.status==='info')){alert(d.message);if(buttonElement)buttonElement.outerHTML=`<span class="status-text">–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω</span>`;updateFriendRequestsBadge();}
            else{throw new Error(d.message||'Fail send');}}
        catch(error){alert('–û—à–∏–±–∫–∞: '+error.message);}};
    async function initiateChatAndShow(friendId, friendUsername) {
        console.log(`Initiating chat with friend ID: ${friendId}, Username: ${friendUsername}`);
        if (!friendId) {
            console.error('Friend ID is missing for initiateChatAndShow');
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å —á–∞—Ç: ID –¥—Ä—É–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω.');
            return;
        }
        try {
            const response = await fetch(API_GET_OR_CREATE_PRIVATE_CHAT_URL(friendId), { // Make sure API_GET_OR_CREATE_PRIVATE_CHAT_URL is a function
                        method: 'POST', 
                        headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                }
            });
            console.log('Response from get_or_create_private_chat:', response);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: 'Server error, unable to parse JSON.' }));
                console.error('Failed to get or create private chat:', response.status, errorData);
                alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å —á–∞—Ç —Å ${friendUsername}. ${errorData.message || ''}`);
                return;
            }
            const data = await response.json();
            console.log('Data from get_or_create_private_chat:', data);
            if (data.status === 'success' && data.room_id) {
                console.log(`Chat room ready. Room ID: ${data.room_id}. Opening chat view for ${friendUsername}`);
                // For a private chat, isGroup is false, creatorId is null (or not relevant here), participantIds are current user and friend
                const participantIds = [parseInt(currentUserId, 10), parseInt(friendId, 10)];
                showChatView(data.room_id, friendUsername, false, null, participantIds);
                        } else {
                console.error('Failed to get room_id from server:', data.message);
                alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID —á–∞—Ç–∞ –¥–ª—è ${friendUsername}. ${data.message || '–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç ID —á–∞—Ç–∞.'}`);
                    }
                } catch (error) {
            console.error('Error in initiateChatAndShow:', error);
            alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –Ω–∞—á–∞—Ç—å —á–∞—Ç —Å ${friendUsername}.`);
        }
    }
    async function loadFriends() {
        if (!friendListContainer) {
            console.error('friendListContainer not found');
            return;
        }
        friendListContainer.innerHTML = '<p class="placeholder-text">–ó–∞–≥—Ä—É–∑–∫–∞ –¥—Ä—É–∑–µ–π...</p>';
        try {
            const response = await fetch(API_GET_FRIENDS_URL); // Ensure API_GET_FRIENDS_URL is defined
            if (!response.ok) throw new Error('Friends load fail - HTTP status ' + response.status);
            const friends = await response.json();
            if (!Array.isArray(friends)) {
                console.error('Friends API did not return an array:', friends);
                friendListContainer.innerHTML = '<p class="placeholder-text" style="color:red;">–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.</p>';
                return;
            }
            if (friends.length === 0) {
                friendListContainer.innerHTML = '<p class="placeholder-text">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π.</p>';
                return;
            }
            friendListContainer.innerHTML = ''; // Clear loading/placeholder

            friends.forEach(friend => {
                const item = document.createElement('div');
                item.className = 'friend-item';
                item.dataset.friendId = friend.id;

                // Use classes for buttons and data attributes for parameters
                item.innerHTML = `
                    <img src="${friend.profile_picture_url || defaultAvatarUrl}" class="friend-avatar" alt="${friend.username}" onerror="this.src='${defaultAvatarUrl}'">
                    <div class="friend-info">
                        <span class="friend-name">${friend.username}</span>
                        <div class="friend-actions">
                            <button class="friend-action-link js-friend-write" data-friend-id="${friend.id}" data-friend-username="${friend.username}">–ù–∞–ø–∏—Å–∞—Ç—å</button>
                            <button class="friend-action-link js-friend-schedule" data-friend-id="${friend.id}" data-friend-username="${friend.username}">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
                    </div>
                    </div>
                    <button class="friend-options js-friend-options" title="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ" data-friend-id="${friend.id}" data-friend-username="${friend.username}">‚ãÆ</button>
                `;

                const optsMenu = document.createElement('div');
                optsMenu.className = 'friend-context-menu';
                optsMenu.style.display = 'none';
                item.appendChild(optsMenu);

                friendListContainer.appendChild(item);

                const writeBtn = item.querySelector('.js-friend-write');
                if (writeBtn) {
                    writeBtn.addEventListener('click', function() {
                        if (typeof initiateChatAndShow === 'function') {
                            initiateChatAndShow(this.dataset.friendId, this.dataset.friendUsername);
                        } else {
                            console.error('initiateChatAndShow function is not defined when listener attached.');
                        }
                    });
                }

                const scheduleBtn = item.querySelector('.js-friend-schedule');
                if (scheduleBtn) {
                    scheduleBtn.addEventListener('click', function() {
                        if (typeof viewFriendSchedule === 'function') {
                            viewFriendSchedule(this.dataset.friendId, this.dataset.friendUsername);
                        } else {
                            console.error('viewFriendSchedule function is not defined when listener attached.');
                        }
                    });
                }

                const optionsBtn = item.querySelector('.js-friend-options');
                if (optionsBtn) {
                    optionsBtn.addEventListener('click', function(event) {
                        if (typeof showFriendOptions === 'function') {
                            showFriendOptions(this.dataset.friendId, this.dataset.friendUsername, event);
                        } else {
                            console.error('showFriendOptions function is not defined when listener attached.');
                        }
                    });
                }
            });
        } catch (error) {
            friendListContainer.innerHTML = '<p class="placeholder-text" style="color:red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥—Ä—É–∑–µ–π.</p>';
            console.error('Error in loadFriends:', error);
        }
    }
    window.showFriendOptions = (friendId, friendUsername, event) => {
        if (event) {
            event.stopPropagation();
            event.preventDefault();
        }

        document.querySelectorAll('.friend-context-menu').forEach(m => {
            if (event && m !== event.target.closest('.friend-item').querySelector('.friend-context-menu')) {
                m.style.display = 'none';
                m.innerHTML = '';
            }
        });

        const item = event && event.target ? event.target.closest('.friend-item') : null;
        if (!item) {
            console.warn('Could not find parent .friend-item for options menu.');
            return;
        }

        let menu = item.querySelector('.friend-context-menu');
        if (!menu) {
            console.warn('Friend context menu div not found in item, creating it.');
            menu = document.createElement('div');
            menu.className = 'friend-context-menu';
            item.appendChild(menu);
        }

        if (menu.style.display === 'block') {
            menu.style.display = 'none';
            menu.innerHTML = '';
        } else {
            menu.innerHTML = `<button class="context-menu-button js-remove-friend" data-friend-id="${friendId}" data-friend-username="${friendUsername}">–£–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π</button>`;
            menu.style.display = 'block';
            menu.style.position = 'absolute';
            menu.style.backgroundColor = 'white';
            menu.style.border = '1px solid #ccc';
            menu.style.padding = '5px';
            menu.style.zIndex = '1000';
            const buttonRect = event.target.getBoundingClientRect();
            const listRect = friendListContainer.getBoundingClientRect();

            menu.style.top = (buttonRect.bottom - listRect.top + friendListContainer.scrollTop) + 'px';
            menu.style.left = (buttonRect.left - listRect.left + friendListContainer.scrollLeft) + 'px';

            const removeBtn = menu.querySelector('.js-remove-friend');
            if (removeBtn) {
                removeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    removeFriend(this.dataset.friendId, this.dataset.friendUsername);
                    menu.style.display = 'none';
                    menu.innerHTML = '';
                });
            }
        }
    };
    window.viewFriendSchedule = (friendId, friendUsername) => {
        currentlyViewedUserId=friendId; document.getElementById('timelineUserDisplay').textContent=`–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: ${friendUsername}`;
        document.getElementById('myScheduleButton').style.display='inline-block';
        if(selectedStartDate){generateTimelineView(new Date(selectedStartDate+"T00:00:00+07:00"),selectedEndDate?new Date(selectedEndDate+"T23:59:59.999+07:00"):new Date(selectedStartDate+"T23:59:59.999+07:00"));}
        else{const t=new Date(),s=new Date(t.setDate(t.getDate()-t.getDay()+1));s.setHours(0,0,0,0);const e=new Date(s);e.setDate(s.getDate()+6);e.setHours(23,59,59,999);generateTimelineView(s,e);}}
    window.removeFriend = async function(friendId, friendUsername) {
        if(!confirm(`–£–¥–∞–ª–∏—Ç—å ${friendUsername} –∏–∑ –¥—Ä—É–∑–µ–π?`))return;
        try{
            const r = await fetch(API_REMOVE_FRIEND_URL(friendId),{method:'POST',headers:{'X-CSRFToken':getCookie('csrftoken'),'Content-Type':'application/json'}});
            const d = await r.json();
            if(r.ok && d.status==='success'){
                alert(d.message);
                loadFriends();
                updateFriendRequestsBadge();
            } else {
                throw new Error(d.message||'Fail remove');
            }
        }
        catch(error){
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: '+error.message);
            console.error('Error in removeFriend:', error);
        }
    };
    async function loadChats() {
        if(!chatListContainer) {
            console.error('chatListContainer not found for loadChats');
            return;
        }
        chatListContainer.innerHTML='<p class="placeholder-text">–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</p>';
        try{
            const response = await fetch("{% url 'chat_room_list_api' %}"); // Using Django URL template tag
            if(!response.ok) throw new Error('Chats API request failed with status ' + response.status);
            const chats = await response.json();
            if (!Array.isArray(chats)) {
                console.error("loadChats: API did not return an array.", chats);
                chatListContainer.innerHTML='<p class="placeholder-text" style="color:red;">–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤.</p>';
                return;
            }
            chatListContainer.innerHTML=''; 
            if(chats.length===0){
                chatListContainer.innerHTML='<p class="placeholder-text">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤.</p>';
                return;
            }
            chats.forEach(chat => {
                // Determine chat name and avatar
                let displayName = chat.name;
                let avatarUrl = defaultAvatarUrl; // Ensure defaultAvatarUrl is defined

                if (chat.is_group) {
                    displayName = chat.name || '–ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç';
                    avatarUrl = chat.group_avatar_url || defaultAvatarUrl; // Assuming a field for group avatar
                    if (!chat.group_avatar_url) avatarUrl = "{% static 'images/group_avatar.png' %}"; // Fallback group avatar
                } else {
                    // For private chats, find the other participant
                    const otherParticipant = chat.participants_details.find(p => p.id.toString() !== currentUserId.toString());
                    if (otherParticipant) {
                        displayName = otherParticipant.username;
                        avatarUrl = otherParticipant.profile_picture_url || defaultAvatarUrl;
                    } else {
                        displayName = chat.name || '–ß–∞—Ç'; // Fallback if other participant not found
                    }
                }
                if (!displayName) displayName = "–ß–∞—Ç –±–µ–∑ –∏–º–µ–Ω–∏";


                const item=document.createElement('div');
                item.className='chat-item';
                item.dataset.roomId=chat.id;
                item.dataset.chatName=displayName; // Use determined displayName
                item.dataset.isGroup=chat.is_group.toString();
                item.dataset.creatorId = chat.creator_id || '';
                item.dataset.participantIds = JSON.stringify(chat.all_participant_ids || []);

                item.addEventListener('click', () => {
                    showChatView(
                        chat.id, 
                        displayName, // Use determined displayName
                        chat.is_group, 
                        chat.creator_id, 
                        chat.all_participant_ids || []
                    );
                });
                
                item.innerHTML=`
                    <img src="${avatarUrl}" class="chat-avatar" alt="${displayName}" onerror="this.src='${defaultAvatarUrl}'">
                    <div class="chat-info">
                        <span class="chat-name">${displayName}</span>
                        <span class="chat-last-message">${chat.last_message_content || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</span>
                    </div>
                    <span class="chat-time">${chat.last_message_at_display || ''}</span>
                `;
                chatListContainer.appendChild(item);
            });
        } catch(error){
            console.error("Error in loadChats:", error);
            chatListContainer.innerHTML='<p class="placeholder-text" style="color:red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤.</p>';
        }
    }
    
    // --- Search Functionality (Left Panel) ---
    if(friendSearchInput) friendSearchInput.addEventListener('input', function() {
            const filter = this.value.toLowerCase();
        friendListContainer.querySelectorAll('.friend-item .friend-name').forEach(nameEl => { nameEl.closest('.friend-item').style.display = nameEl.textContent.toLowerCase().includes(filter) ? '' : 'none';}); });
    if(chatSearchInput) chatSearchInput.addEventListener('input', function() {
            const filter = this.value.toLowerCase();
        chatListContainer.querySelectorAll('.chat-item .chat-name').forEach(nameEl => { nameEl.closest('.chat-item').style.display = nameEl.textContent.toLowerCase().includes(filter) ? '' : 'none';}); });

    // --- Initialize Page ---
    function initializePage() {
        renderSmallCalendar();
        const today = new Date(), dayOfWeek = today.getDay();
        const startOfWeek = new Date(today); startOfWeek.setDate(today.getDate()-dayOfWeek+(dayOfWeek===0?-6:1)); startOfWeek.setHours(0,0,0,0);
        const endOfWeek = new Date(startOfWeek); endOfWeek.setDate(startOfWeek.getDate()+6); endOfWeek.setHours(23,59,59,999);
        selectedStartDate = getKrasnoyarskDateString(startOfWeek); selectedEndDate = getKrasnoyarskDateString(endOfWeek);
        renderSmallCalendar(); generateTimelineView(startOfWeek, endOfWeek);
        const timelineHeaderRow = document.getElementById('timelineHeader');
        if (timelineHeaderRow) {
            timelineHeaderRow.innerHTML = ''; 
            const controlsDiv=document.createElement('div');controlsDiv.className='timeline-header-controls';
            const myScheduleBtn=document.createElement('button');myScheduleBtn.textContent="–ú–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ";myScheduleBtn.className='action-button panel-button';myScheduleBtn.id='myScheduleButton';
            myScheduleBtn.addEventListener('click',()=>{
                currentlyViewedUserId=currentUserId;document.getElementById('timelineUserDisplay').textContent='–ú–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ';
                if(selectedStartDate)generateTimelineView(new Date(selectedStartDate+"T00:00:00+07:00"),selectedEndDate?new Date(selectedEndDate+"T23:59:59.999+07:00"):new Date(selectedStartDate+"T23:59:59.999+07:00"));
                else generateTimelineView(startOfWeek,endOfWeek);
            });
            controlsDiv.appendChild(myScheduleBtn); const userDisp=document.createElement('span');userDisp.id='timelineUserDisplay';userDisp.textContent='–ú–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ';controlsDiv.appendChild(userDisp); timelineHeaderRow.appendChild(controlsDiv);
            const monthTitle=document.createElement('span');monthTitle.className='timeline-month-title';monthTitle.textContent=monthNames[currentSmallCalendarDate.getMonth()];timelineHeaderRow.appendChild(monthTitle);
            const slotsCont=document.createElement('div');slotsCont.className='timeline-header-slots-horizontal';
            const timePoints=[{l:"06:00",p:0},{l:"12:00",p:25},{l:"18:00",p:50},{l:"00:00",p:75},{l:"06:00",p:100}];
            timePoints.forEach(tp=>{const m=document.createElement('div');m.className='timeline-hour-mark-horizontal';m.style.left=`${tp.p}%`;const l=document.createElement('span');l.className='timeline-hour-label-horizontal';l.textContent=tp.l;if(tp.p===0)l.style.transform='translateX(0%)';else if(tp.p===100)l.style.transform='translateX(-100%)';else l.style.transform='translateX(-50%)';m.appendChild(l);slotsCont.appendChild(m);});
            timelineHeaderRow.appendChild(slotsCont);
        }
        
        // Determine and open the initial active tab
        const initiallyActiveTabLink = document.querySelector('.left-panel-tabs .tab-link.active');
        let initialTabId = 'friends-tab-content'; // Default to friends tab
        if (initiallyActiveTabLink && initiallyActiveTabLink.dataset.tab) {
            initialTabId = initiallyActiveTabLink.dataset.tab;
        }
        openTab(initialTabId); // This will also call loadFriends or loadChats

        updateFriendRequestsBadge();
        const showFriendRequestsBtn = document.getElementById('showFriendRequestsBtn');
        if (showFriendRequestsBtn) showFriendRequestsBtn.addEventListener('click',(e)=>{e.preventDefault();displayFriendRequests();});
        const userGlobalSearchInput = document.getElementById('userGlobalSearchInput');
        if (userGlobalSearchInput) userGlobalSearchInput.addEventListener('input',debounce(searchGlobalUsers,300));
        // Global click listener to close friend context menu
        document.addEventListener('click',(event)=>{
            if(!event.target.matches('.friend-options') && !event.target.closest('.friend-context-menu')) {
                document.querySelectorAll('.friend-context-menu').forEach(menu=> {
                    menu.style.display='none';
                    menu.innerHTML = ''; // Clear content when hiding
                });
            }
        });

        // Add event listener for the new back button
        if (chatViewBackButton) {
            chatViewBackButton.addEventListener('click', showTimelineView);
        }
    }

    initializePage();

    window.handleLeaveGroupChat = async () => { 
        stopChatPolling(); // Add this
        const chatViewPanel = document.getElementById('chatViewPanel');
        // ... rest of your function
    };

    function stopChatPolling() {
        if (chatPollingIntervalId) {
            clearInterval(chatPollingIntervalId);
            chatPollingIntervalId = null;
            console.log("Chat polling stopped.");
        }
    }

    let chatPollingIntervalId = null; // For polling new messages
    const POLLING_INTERVAL_MS = 5000; // Poll every 5 seconds
    });
  </script>
{% endblock %}

